sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/m/MessageBox","sap/ui/model/FilterOperator"],function(e,t,a,i,r,l,s,o,n){"use strict";return e.extend("com.bom.sap.com.zbomapp.controller.Worklist",{formatter:a,onInit:function(){var e,a,i=this.byId("table");a=i.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0});this.setModel(e,"worklistView");i.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",a)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#BillOfMaterialApp-display"},true);this.onComplete=false;this.oBusyDialog=new sap.m.BusyDialog;this.oTableRecCount=0},onUpdateFinished:function(e){var t,a=e.getSource(),i=e.getParameter("total");if(i&&a.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[i])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onPress:function(e){this._showObject(e.getSource())},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var a=e.getParameter("query");if(a&&a.length>0){var i=sap.ui.model.FilterOperator.Contains;var r=a.toLowerCase();var l=a.toUpperCase();var s=a[0].toUpperCase()+a.substr(1).toLowerCase();var o=a.replace(/\b\w/g,function(e){return e.toUpperCase()});t=[new sap.ui.model.Filter([new sap.ui.model.Filter("Material",i,a),new sap.ui.model.Filter("Material",i,r),new sap.ui.model.Filter("Material",i,l),new sap.ui.model.Filter("Material",i,s),new sap.ui.model.Filter("Material",i,o),new sap.ui.model.Filter("BillOfMaterialVersion",i,a),new sap.ui.model.Filter("BillOfMaterialVersion",i,r),new sap.ui.model.Filter("BillOfMaterialVersion",i,l),new sap.ui.model.Filter("BillOfMaterialVersion",i,s),new sap.ui.model.Filter("BillOfMaterialVersion",i,o),new sap.ui.model.Filter("ComponentDescription",i,a),new sap.ui.model.Filter("ComponentDescription",i,r),new sap.ui.model.Filter("ComponentDescription",i,l),new sap.ui.model.Filter("ComponentDescription",i,s),new sap.ui.model.Filter("ComponentDescription",i,o)],false)]}this._applySearch(t)}},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("BillOfMaterialHeaderUUID")})},_applySearch:function(e){var t=this.byId("table"),a=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){a.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("idPlant").setValue(t.toUpperCase())},onEnterMatNo:function(e){var t=this.getView().byId("multiInput").getValue();this.getView().byId("multiInput").addToken(new sap.m.Token({text:t}));this.getView().byId("multiInput").setValue("")},onEnter:function(){this.oBusyDialog.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSerch()}if(t==="Cancel"){e.oBusyDialog.close()}},initialFocus:"OK"})},onBOMSerch:function(){var e=new sap.m.BusyDialog;var t="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var a=new sap.ui.model.odata.ODataModel(t,true);a.setDefaultBindingMode("TwoWay");a.attachRequestSent(function(){e.open()});var i=new sap.ui.model.json.JSONModel;var r=new sap.ui.model.json.JSONModel;var l=new sap.ui.model.json.JSONModel;l.results=[];var s=[];var o=0;var n="";var u=new Array;var p=[];var d=true;var g=0;var m=[];var c=0;var h=0;var f=false;var w=true;var M=0;var v=false;var B=this.getView().byId("multiInput").getTokens();var O=this.getView().byId("idPlant").getValue().toString();var y=this.getView().byId("idBOMUsage").getValue().toString();var T=this.getView().byId("idBOMApp").getValue().toString();if(B.length===0||O.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");this.oBusyDialog.close()}else{var t="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var b=new sap.ui.model.odata.ODataModel(t,true);b.setDefaultBindingMode("TwoWay");var I=2;u[0]=new sap.ui.model.Filter("BillOfMaterialVariant",sap.ui.model.FilterOperator.EQ,T);u[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,O);u[2]=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,y);for(var V=0;V<B.length;V++){I++;var C=this.getView().byId("multiInput").getTokens()[V].getProperty("text");u[I]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,C)}b.read("/MaterialBOM",{filters:u,urlParameters:{$select:"Material"},async:false,success:function(t,a){for(var l=0;l<t.results.length;l++){m[l]=t.results[l].Material}var p="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var g=new sap.ui.model.odata.ODataModel(p,true);g.setDefaultBindingMode("TwoWay");c=m.length;do{u=[];var w=1;u[0]=new sap.ui.model.Filter("BillOfMaterialVariant",sap.ui.model.FilterOperator.EQ,T);u[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,O);w++;u[w]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,m[h]);g.read("/MaterialBOMItem",{filters:u,urlParameters:{$select:"BillOfMaterialVersion,Material,ComponentDescription,Plant,BillOfMaterialItemQuantity,BillOfMaterialCategory,IsAssembly,BillOfMaterialComponent,IsSubItem"},async:false,success:function(e,t){if(!v){}else{o=o+1;v=false}if(d){for(var a=0;a<e.results.length;a++){e.results[a].IsSubItem=o}for(var l=0;l<e.results.length;l++){e.results[l].BillOfMaterialVersion=m[h];e.results[l].Material=e.results[l].BillOfMaterialComponent}r.setData(e);d=false}else{for(var u=0;u<e.results.length;u++){e.results[u].BillOfMaterialVersion=m[h];e.results[u].Material=e.results[u].BillOfMaterialComponent;e.results[u].IsSubItem=o}i.setData(e);for(var p=0;p<i.getProperty("/results").length;p++){r.getProperty("/results").push(i.getProperty("/results/"+p))}}for(var p=0;p<e.results.length;p++){if(e.results[p].IsAssembly.length>0){n="X";s[M]=e.results[p].BillOfMaterialComponent;M++}}if(s.length>0){n="X"}else{n=""}},error:function(t){e.close();sap.m.MessageBox.error(t.message)}});h=h+1;if(h<m.length){f=true}else if(n.length>0){m=[];m=s;h=0;v=true;M=0;s=[];f=true}else{f=false}}while(f)},error:function(t){e.close();sap.m.MessageBox.error(t.message)}});var S=this;S.getView().setModel(r,"itemModel");S.oTableRecCount=r.getData().results.length;S.onComplete=true;this.oBusyDialog.close()}},onExport:function(e){var t=this.oTableRecCount;if(t===0){var a=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(a)}else{var i=new Date;var r=i.getUTCDate()+"-"+(i.getUTCMonth()+1)+"-"+i.getUTCFullYear()+" "+i.getUTCHours()+":"+i.getUTCMinutes()+":"+i.getUTCSeconds();var l="Bom Data_".concat(r);var s=new sap.ui.core.util.Export({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:",",charset:"utf-8"}),models:this.getView().getModel("itemModel"),rows:{path:"/results"},columns:[{name:"BOM Material",template:{content:"{BillOfMaterialVersion}"}},{name:"Material",template:{content:"{Material}"}},{name:"Level",template:{content:"{IsSubItem}"}},{name:"Comp Desc",template:{content:"{ComponentDescription}"}},{name:"BOM Quantity",template:{content:"{BillOfMaterialItemQuantity}"}},{name:"Plant",template:{content:"{Plant}"}},{name:"BOM Category",template:{content:"{BillOfMaterialCategory}"}}]});s.saveFile(l).catch(function(e){n.error("Error when downloading data. Browser might not be supported!\n\n"+e)}).then(function(){s.destroy()})}},onReset:function(e){this.getView().byId("multiInput").removeAllTokens();this.getView().byId("idPlant").setValue("");this.getView().byId("idBOMUsage").setValue("");this.getView().byId("idBOMApp").setValue("");var t=new sap.ui.model.json.JSONModel;var a=[];t.setData(a);var i=t.getProperty("/d/results");t.setData({modelData:i});this.getView().setModel(t,"itemModel")},handleSortStdConfirm:function(e){var t=this.oTableRecCount;if(t===0){var a=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(a)}else{var i=e.getParameters().sortDescending;var r=e.getParameters().sortItem.getText();var l;var s=false;var o=[];var n;if(i){l=true}else{l=false}var u=this.getView();var p=u.byId("table");var d=p.getBinding("items");if(r==="Material"){n="Material"}else if(r==="Comp Desc"){n="ComponentDescription"}else if(r==="BOM Quantity"){n="BillOfMaterialItemQuantity"}else if(r==="Level"){n="IsSubItem"}o.push(new sap.ui.model.Sorter(n,l,s));d.sort(o)}}})});