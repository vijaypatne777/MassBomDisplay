sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","../model/formatter","sap/ui/model/Filter","sap/ui/core/util/Export","sap/ui/core/util/ExportTypeCSV","sap/m/MessageBox","sap/ui/model/FilterOperator"],function(e,t,i,a,l,r,o,s,n){"use strict";return e.extend("com.bom.sap.com.zbomapp.controller.Worklist",{formatter:i,oDataInitial:{Items:[{columnKey:"productId",text:"Product ID"},{columnKey:"name",text:"Name"},{columnKey:"category",text:"Category"},{columnKey:"supplierName",text:"Supplier Name"},{columnKey:"description",text:"Description"},{columnKey:"weightMeasure",text:"Weight Measure"},{columnKey:"weightUnit",text:"WeightUnit"},{columnKey:"price",text:"Price"},{columnKey:"currencyCode",text:"Currency Code"},{columnKey:"status",text:"Status"},{columnKey:"quantity",text:"Quantity"},{columnKey:"uom",text:"UoM"},{columnKey:"width",text:"Width"},{columnKey:"depth",text:"Depth"},{columnKey:"height",text:"Height"},{columnKey:"dimUnit",text:"DimUnit"},{columnKey:"productPicUrl",text:"ProductPicUrl"}],ColumnsItems:[{columnKey:"name",visible:true,index:0},{columnKey:"category",visible:true,index:1},{columnKey:"productId",visible:false},{columnKey:"supplierName",visible:false},{columnKey:"description",visible:false},{columnKey:"weightMeasure",visible:false},{columnKey:"weightUnit",visible:false},{columnKey:"price",visible:false},{columnKey:"currencyCode",visible:false},{columnKey:"status",visible:false},{columnKey:"quantity",visible:false},{columnKey:"uom",visible:false},{columnKey:"width",visible:false},{columnKey:"depth",visible:false},{columnKey:"height",visible:false},{columnKey:"dimUnit",visible:false},{columnKey:"productPicUrl",visible:false}],ShowResetEnabled:false},oJSONModel:null,oDataBeforeOpen:{},onInit:function(){var e,i,a=this.byId("table");i=a.getBusyIndicatorDelay();this._aTableSearchState=[];e=new t({worklistTableTitle:this.getResourceBundle().getText("worklistTableTitle"),saveAsTileTitle:this.getResourceBundle().getText("saveAsTileTitle",this.getResourceBundle().getText("worklistViewTitle")),shareOnJamTitle:this.getResourceBundle().getText("worklistTitle"),shareSendEmailSubject:this.getResourceBundle().getText("shareSendEmailWorklistSubject"),shareSendEmailMessage:this.getResourceBundle().getText("shareSendEmailWorklistMessage",[location.href]),tableNoDataText:this.getResourceBundle().getText("tableNoDataText"),tableBusyDelay:0});this.setModel(e,"worklistView");a.attachEventOnce("updateFinished",function(){e.setProperty("/tableBusyDelay",i)});this.addHistoryEntry({title:this.getResourceBundle().getText("worklistViewTitle"),icon:"sap-icon://table-view",intent:"#BillOfMaterialApp-display"},true);this.onComplete=false;this.oBusyDialog=new sap.m.BusyDialog;this.oTableRecCount=0;this.oJSONModel=new t(jQuery.extend(true,{},this.oDataInitial));this.oJSONModel.setDefaultBindingMode(sap.ui.model.BindingMode.TwoWay)},onUpdateFinished:function(e){var t,i=e.getSource(),a=e.getParameter("total");if(a&&i.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("worklistTableTitleCount",[a])}else{t=this.getResourceBundle().getText("worklistTableTitle")}this.getModel("worklistView").setProperty("/worklistTableTitle",t)},onPress:function(e){this._showObject(e.getSource())},onShareInJamPress:function(){var e=this.getModel("worklistView"),t=sap.ui.getCore().createComponent({name:"sap.collaboration.components.fiori.sharing.dialog",settings:{object:{id:location.href,share:e.getProperty("/shareOnJamTitle")}}});t.open()},onSearch:function(e){if(e.getParameters().refreshButtonPressed){this.onRefresh()}else{var t=[];var i=e.getParameter("query");if(i&&i.length>0){var a=sap.ui.model.FilterOperator.Contains;var l=i.toLowerCase();var r=i.toUpperCase();var o=i[0].toUpperCase()+i.substr(1).toLowerCase();var s=i.replace(/\b\w/g,function(e){return e.toUpperCase()});t=[new sap.ui.model.Filter([new sap.ui.model.Filter("Material",a,i),new sap.ui.model.Filter("Material",a,l),new sap.ui.model.Filter("Material",a,r),new sap.ui.model.Filter("Material",a,o),new sap.ui.model.Filter("Material",a,s),new sap.ui.model.Filter("BillOfMaterialVersion",a,i),new sap.ui.model.Filter("BillOfMaterialVersion",a,l),new sap.ui.model.Filter("BillOfMaterialVersion",a,r),new sap.ui.model.Filter("BillOfMaterialVersion",a,o),new sap.ui.model.Filter("BillOfMaterialVersion",a,s),new sap.ui.model.Filter("ComponentDescription",a,i),new sap.ui.model.Filter("ComponentDescription",a,l),new sap.ui.model.Filter("ComponentDescription",a,r),new sap.ui.model.Filter("ComponentDescription",a,o),new sap.ui.model.Filter("ComponentDescription",a,s)],false)]}this._applySearch(t)}},onRefresh:function(){var e=this.byId("table");e.getBinding("items").refresh()},_showObject:function(e){this.getRouter().navTo("object",{objectId:e.getBindingContext().getProperty("BillOfMaterialHeaderUUID")})},_applySearch:function(e){var t=this.byId("table"),i=this.getModel("worklistView");t.getBinding("items").filter(e,"Application");if(e.length!==0){i.setProperty("/tableNoDataText",this.getResourceBundle().getText("worklistNoDataWithSearchText"))}},onLiveChange:function(e){var t=e.getSource().getValue();this.getView().byId("idPlant").setValue(t.toUpperCase())},onEnterMatNo:function(e){var t=this.getView().byId("multiInput").getValue();var i=t[t.length-1];if(i===","){t=t.substring(0,t.length-1)}var a=new Array;a=t.split(",");for(var l=0;l<a.length;l++){this.getView().byId("multiInput").addToken(new sap.m.Token({text:a[l]}));this.getView().byId("multiInput").setValue("")}},onEnter:function(){this.oBusyDialog.open();var e=this;sap.m.MessageBox.show(" Do you want to proceed?.",{icon:sap.m.MessageBox.Icon.INFORMATION,title:"          Search BOM",actions:["OK","Cancel"],onClose:function(t){if(t==="OK"){e.onBOMSerch()}if(t==="Cancel"){e.oBusyDialog.close()}},initialFocus:"OK"})},testExpand:function(e){var t=sap.ui.xmlfragment("com.bom.sap.com.zbomapp.view.PersonalizationDialog",this);this.oJSONModel.setProperty("/ShowResetEnabled",this._isChangedColumnsItems());t.setModel(this.oJSONModel);this.getView().addDependent(t);this.oDataBeforeOpen=jQuery.extend(true,{},this.oJSONModel.getData());t.open()},onBOMSerch:function(){var e=new sap.m.BusyDialog;var t="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var i=new sap.ui.model.odata.ODataModel(t,true);i.setDefaultBindingMode("TwoWay");i.attachRequestSent(function(){e.open()});var a=new sap.ui.model.json.JSONModel;var l=new sap.ui.model.json.JSONModel;var r=new sap.ui.model.json.JSONModel;r.results=[];var o=[];var s=0;var n="";var u=new Array;var d=[];var m=true;var c=0;var p=[];var g=0;var f=0;var h=false;var y=true;var v=0;var M=false;var w="";var B=this.getView().byId("multiInput").getTokens();var O=this.getView().byId("idPlant").getValue().toString();var b=this.getView().byId("idBOMUsage1").getValue().toString();var C=this.getView().byId("idBOMUsage2").getValue().toString();var S=this.getView().byId("idBOMApp").getValue().toString();if(B.length===0||O.length===0){sap.m.MessageBox.warning("Please enter all mandatory fields.");this.oBusyDialog.close()}else{var t="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var I=new sap.ui.model.odata.ODataModel(t,true);I.setDefaultBindingMode("TwoWay");var D=3;u[0]=new sap.ui.model.Filter("BillOfMaterialVariant",sap.ui.model.FilterOperator.EQ,S);u[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,O);u[2]=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,b);u[3]=new sap.ui.model.Filter("BillOfMaterialVariantUsage",sap.ui.model.FilterOperator.EQ,C);for(var V=0;V<B.length;V++){D++;var x=this.getView().byId("multiInput").getTokens()[V].getProperty("text");u[D]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,x)}I.read("/MaterialBOM",{filters:u,urlParameters:{$select:"Material"},async:false,success:function(t,i){for(var r=0;r<t.results.length;r++){p[r]=t.results[r].Material}var d="/OPENSAP/sap/opu/odata/sap/API_BILL_OF_MATERIAL_SRV;v=0002";var c=new sap.ui.model.odata.ODataModel(d,true);c.setDefaultBindingMode("TwoWay");g=p.length;do{u=[];var y=1;u[0]=new sap.ui.model.Filter("BillOfMaterialVariant",sap.ui.model.FilterOperator.EQ,S);u[1]=new sap.ui.model.Filter("Plant",sap.ui.model.FilterOperator.EQ,O);y++;u[y]=new sap.ui.model.Filter("Material",sap.ui.model.FilterOperator.EQ,p[f]);c.read("/MaterialBOMItem",{urlParameters:{$select:"BillOfMaterialVersion,Material,ComponentDescription,Plant,BillOfMaterialItemQuantity,BillOfMaterialCategory,IsAssembly,BillOfMaterialComponent,IsSubItem,BillOfMaterialItemNumber,BillOfMaterial,BillOfMaterialVariant,EngineeringChangeDocument,SpecialProcurementType"},filters:u,async:false,success:function(e,t){var i=e.results[0].BillOfMaterial;var r=e.results[0].BillOfMaterialCategory;var d=e.results[0].BillOfMaterialVariant;var g=e.results[0].BillOfMaterialVersion;var h=e.results[0].EngineeringChangeDocument;var y=e.results[0].Material;var B=e.results[0].Plant;var O="/MaterialBOM(BillOfMaterial='"+i+"',BillOfMaterialCategory='"+r+"',BillOfMaterialVariant='"+d+"',BillOfMaterialVersion='"+g+"',EngineeringChangeDocument='"+h+"',Material='"+y+"',Plant='"+B+"')";c.read(O,{urlParameters:{$select:"BillOfMaterialVariantUsage,Material"},filters:u,async:false,success:function(e,t){w=e.BillOfMaterialVariantUsage},error:function(e){}});if(!M){}else{s=s+1;M=false}if(m){for(var b=0;b<e.results.length;b++){e.results[b].IsSubItem=s;e.results[b].SpecialProcurementType=w}for(var C=0;C<e.results.length;C++){e.results[C].BillOfMaterialVersion=p[f];e.results[C].Material=e.results[C].BillOfMaterialComponent}l.setData(e);m=false}else{for(var S=0;S<e.results.length;S++){e.results[S].BillOfMaterialVersion=p[f];e.results[S].Material=e.results[S].BillOfMaterialComponent;e.results[S].IsSubItem=s;e.results[S].SpecialProcurementType=w}a.setData(e);for(var I=0;I<a.getProperty("/results").length;I++){l.getProperty("/results").push(a.getProperty("/results/"+I))}}for(var I=0;I<e.results.length;I++){if(e.results[I].IsAssembly.length>0){n="X";o[v]=e.results[I].BillOfMaterialComponent;v++}}if(o.length>0){n="X"}else{n=""}},error:function(t){e.close();sap.m.MessageBox.error(t.message)}});f=f+1;if(f<p.length){h=true}else if(n.length>0){p=[];p=o;f=0;M=true;v=0;o=[];h=true}else{h=false}}while(h)},error:function(t){e.close();sap.m.MessageBox.error(t.message)}});var T=this;T.getView().setModel(l,"itemModel");T.oTableRecCount=l.getData().results.length;T.onComplete=true;this.oBusyDialog.close()}},onExport:function(e){var t=this.oTableRecCount;if(t===0){var i=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(i)}else{var a=["BOM Material","Material"];var l=["BillOfMaterialVersion","Material"];var r=[];for(var o=0;o<2;o++){var s="{"+l[o]+"}";r.push({name:a[o],template:{content:s}})}var u=[{name:"BOM Material",template:{content:"{BillOfMaterialVersion}"}},{name:"Material",template:{content:"{Material}"}},{name:"Level",template:{content:"{IsSubItem}"}},{name:"Component Description",template:{content:"{ComponentDescription}"}},{name:"BOM Quantity",template:{content:"{BillOfMaterialItemQuantity}"}},{name:"Plant",template:{content:"{Plant}"}},{name:"BOM Category",template:{content:"{BillOfMaterialCategory}"}}];var d=new Date;var m=d.getUTCDate()+"-"+(d.getUTCMonth()+1)+"-"+d.getUTCFullYear()+" "+d.getUTCHours()+":"+d.getUTCMinutes()+":"+d.getUTCSeconds();var c="Bom Data_".concat(m);var p=new sap.ui.core.util.Export({exportType:new sap.ui.core.util.ExportTypeCSV({separatorChar:",",charset:"utf-8"}),models:this.getView().getModel("itemModel"),rows:{path:"/results"},columns:u});p.saveFile(c).catch(function(e){n.error("Error when downloading data. Browser might not be supported!\n\n"+e)}).then(function(){p.destroy()})}},onReset:function(e){this.getView().byId("multiInput").removeAllTokens();this.getView().byId("idPlant").setValue("");this.getView().byId("idBOMUsage1").setValue("");this.getView().byId("idBOMUsage2").setValue("");var t=new sap.ui.model.json.JSONModel;var i=[];t.setData(i);var a=t.getProperty("/d/results");t.setData({modelData:a});this.getView().setModel(t,"itemModel")},handleSortButtonPressed:function(e){if(!this._oViewSettingsDialog){this._oViewSettingsDialog=sap.ui.xmlfragment("com.bom.sap.com.zbomapp.view.SortDialog",this);this.getView().addDependent(this._oViewSettingsDialog);this._oViewSettingsDialog.addStyleClass(this.getOwnerComponent().getContentDensityClass())}this._oViewSettingsDialog.open()},onCancelReject:function(e){if(this._oViewSettingsDialog.isOpen()){this._oViewSettingsDialog.close()}},handleSortStdConfirm:function(e){var t=this.oTableRecCount;if(t===0){var i=this.getView().getModel("i18n").getResourceBundle().getText("oTableNoDataText");sap.m.MessageBox.warning(i)}else{var a=e.getParameters().sortDescending;var l=e.getParameters().sortItem.getText();var r;var o=false;var s=[];var n;if(a){r=true}else{r=false}var u=this.getView();var d=u.byId("table");var m=d.getBinding("items");if(l==="Header Material"){n="BillOfMaterialVersion"}else if(l==="BOM Component"){n="Material"}else if(l==="Component Description"){n="ComponentDescription"}else if(l==="Level"){n="IsSubItem"}else if(l==="BOM Qty Item No"){n="BillOfMaterialItemNumber"}s.push(new sap.ui.model.Sorter(n,r,o));m.sort(s)}},onOK:function(e){this.oDataBeforeOpen={};e.getSource().close();e.getSource().destroy()},onCancel:function(e){this.oJSONModel.setProperty("/",jQuery.extend(true,[],this.oDataBeforeOpen));this.oDataBeforeOpen={};e.getSource().close();e.getSource().destroy()},onReset1:function(){this.oJSONModel.setProperty("/",jQuery.extend(true,[],this.oDataInitial))},onChangeColumnsItems:function(e){this.oJSONModel.setProperty("/ColumnsItems",e.getParameter("items"));this.oJSONModel.setProperty("/ShowResetEnabled",this._isChangedColumnsItems())},_isChangedColumnsItems:function(){var e=function(e,t,i){var a=i.filter(function(i){return i[e]!==undefined&&i[e]===t});return a.length?a[0]:null};var t=function(t,i){if(!i){return jQuery.extend(true,[],t)}var a=jQuery.extend(true,[],i);t.forEach(function(t){var i=e("columnKey",t.columnKey,a);if(!i){a.push(t);return}if(i.visible===undefined&&t.visible!==undefined){i.visible=t.visible}if(i.width===undefined&&t.width!==undefined){i.width=t.width}if(i.total===undefined&&t.total!==undefined){i.total=t.total}if(i.index===undefined&&t.index!==undefined){i.index=t.index}});return a};var i=function(e,t){if(!t){return true}if(e.length!==t.length){return false}var i=function(e,t){if(e.columnKey<t.columnKey){return-1}else if(e.columnKey>t.columnKey){return 1}else{return 0}};e.sort(i);t.sort(i);var a=e.filter(function(e,i){return e.columnKey!==t[i].columnKey||e.visible!==t[i].visible||e.index!==t[i].index||e.width!==t[i].width||e.total!==t[i].total});return a.length===0};var a=t(this.oDataInitial.ColumnsItems,this.oJSONModel.getProperty("/ColumnsItems"));return!i(a,this.oDataInitial.ColumnsItems)}})});